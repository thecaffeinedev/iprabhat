I"d.<p><img src="./cvm1.png" alt="Cover image" />
In this blog post, we are going to build and install OpenCV on anM1 Mac.</p>

<p>Last year in November 2020 apple releases their first ARM64-based M1 chip. It got a lot of attention from everyone.</p>

<p>Being a tech enthusiast and a programmer, I was amazed to see the performance of the new apple M1 chip. The benchmarks were really good.</p>

<p>Recently only some months back, I bought myself an M1 Macbook Pro with 8Gigs of RAM and 512GB of SSD.
Let’s get started.</p>

<p>Here are the things that we are going to do.</p>

<p>Here are the things that we are going to do.</p>

<ul>
  <li>Step 1: Homebrew and Xcode Command Line Tools Installation</li>
  <li>Step2: Install Miniforge</li>
  <li>Step3: Create a virtual environment with python3.8</li>
  <li>Step4: Install necessary dependencies</li>
  <li>Step5: Compile and Build OpenCV</li>
  <li>Step6: Test OpenCV</li>
</ul>

<h1 id="step1-homebrew-and-xcode-cli-installation">Step1: Homebrew and XCode CLI Installation</h1>

<p>If Homebrew is not already installed in your system you can install it by running the following in your terminal.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

</code></pre></div></div>

<p>After it gets installed, install wget and CMake.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install wget cmake
</code></pre></div></div>

<p>I have already installed Xcode Command Line Tools on my mac. If it’s not already installed in your system, you can install it by running the following command below in your terminal.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xcode-select --install
</code></pre></div></div>

<h2 id="step2-install-miniforge">Step2: Install Miniforge</h2>

<p>Install miniforge for arm64 (Apple Silicon) from <a href="https://github.com/conda-forge/miniforge">miniforge GitHub</a>.</p>

<p>Miniforge enables installing python packages natively compiled for Apple Silicon.</p>

<p>After the installation of miniforge, by default, it gives us one base environment. You can turn off the default base env by running</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda config --set auto_activate_base false
</code></pre></div></div>

<h2 id="step3-create-a-virtual-environment">Step3: Create a virtual environment</h2>

<p>Let’s create a virtual environment named mlp with python3.8 installed.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda create --name testcv python=3.8
</code></pre></div></div>

<p><img src="https://miro.medium.com/max/700/1*NIKNl9-7FvfL3go-NPR8uQ.png" alt="" /></p>

<p>And activate it by running</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda activate testcv

</code></pre></div></div>

<h2 id="step4-installing-some-dependencies">Step4: Installing Some Dependencies</h2>

<p>As we are going to install OpenCV natively we have to install the compatible version of Numpy which Apple provides for M1.</p>

<p>Run the following commands below on a terminal to install Numpy</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/apple/tensorflow_macos/releases/download/v0.1alpha3/tensorflow_macos-0.1alpha3.tar.gz

tar -xvf tensorflow_macos-0.1alpha3.tar.gzcd tensorflow_macos/arm64

cd tensorflow_macos/arm64

pip install --upgrade --no-dependencies --force numpy-1.18.5-cp38-cp38-macosx_11_0_arm64.whl

cd ~

</code></pre></div></div>

<h2 id="step5-compile-and-build-opencv">Step5: Compile and Build OpenCV</h2>

<p>We have to download OpenCV and OpenCV Contrib first.</p>

<p>I have created one folder named test_opencv where I will be downloading files and build there.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
wget -O opencv.zip https://github.com/opencv/opencv/archive/4.5.0.zip

wget -O opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/4.5.0.zip

unzip opencv.zip &amp;&amp; unzip opencv_contrib.zip

cd opencv-4.5.0

mkdir build &amp;&amp; cd build

</code></pre></div></div>

<p>Let’s Set up the OpenCV build with CMake:</p>

<p>Make sure to put your own PATH on OPENCV_EXTRA_MODULES</p>

<p>Also, make sure to activate your conda environment before running make.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda activate testcv

</code></pre></div></div>

<p>You have to put your Python3 executable path also. You can get it by running</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo $CONDA_PREFIX
</code></pre></div></div>

<p><img src="https://miro.medium.com/max/700/1*IZc7yOIpjLtfaj4KlRU1DA.png" alt="" /></p>

<p>For eg: My path is</p>

<p><em>/opt/homebrew/Caskroom/miniforge/base/envs/testcv/</em></p>

<p>So I have put</p>

<p><em>/opt/homebrew/Caskroom/miniforge/base/envs/testcv/bin/python3</em></p>

<p>You have to change and put your own path there.</p>

<p>Now you can run</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
cmake \
 DCMAKE_SYSTEM_PROCESSOR=arm64 \
-DCMAKE_OSX_ARCHITECTURES=arm64 \
-DWITH_OPENJPEG=OFF \
-DWITH_IPP=OFF \
-D CMAKE_BUILD_TYPE=RELEASE \
-D CMAKE_INSTALL_PREFIX=/usr/local \
-D OPENCV_EXTRA_MODULES_PATH=/Users/caffeinedev/Prabhat/Workspace/test_opencv/opencv_contrib-4.5.0/modules \
-D PYTHON3_EXECUTABLE=/opt/homebrew/Caskroom/miniforge/base/envs/testcv/bin/python3 \
-D BUILD_opencv_python2=OFF \
-D BUILD_opencv_python3=ON \
-D INSTALL_PYTHON_EXAMPLES=ON \
-D INSTALL_C_EXAMPLES=OFF \
-D OPENCV_ENABLE_NONFREE=ON \
-D BUILD_EXAMPLES=ON ..

</code></pre></div></div>

<p>Snapshots</p>

<p><img src="https://miro.medium.com/max/700/1*7ERmg-sL7tL5SGQfAAcwMg.png" alt="" /></p>

<p>You will see the screen below after Cmake. The compilation doesn’t take that much time.</p>

<p><img src="https://miro.medium.com/max/700/1*QgSSYmqBrJ3MP4S7wYjvQA.png" alt="" /></p>

<p>Now we have the run the make command.</p>

<p>Here j8 stands for 8 cores. You can do either make or you can adjust the j option. So let’s run</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make -j8

</code></pre></div></div>

<p>You will get an output like the below. It took around 10 minutes for me.</p>

<p><img src="https://miro.medium.com/max/700/1*GLl6bTvsk8yjqx-yHORpWQ.png" alt="" /></p>

<p>Then the last step is to run</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo make install

</code></pre></div></div>
<p><img src="https://miro.medium.com/max/700/1*nqZVMgbuGbe3AKqBCTJ08w.png" alt="" /></p>

<p>You will get the above after sudo make install.</p>

<h4 id="sym-link-opencv-4-on-macos-to-virtual-environment-site-packages">Sym-link OpenCV 4 on macOS to virtual environment site-packages</h4>

<p>We need to first locate the .so file, which has been generated during the compilation of OpenCV.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mdfind cv2.cpython
</code></pre></div></div>
<p><img src="https://miro.medium.com/max/700/1*98ZgMVdER2yyTYpADnRLXg.png" alt="" /></p>

<p>Now, we need to execute the following to sym-link one of the .so files in our current Python virtual environment.</p>

<p>You can see this from the screenshot. There’s one so file that has been generated inside the build folder. The path to the .so file in my system is</p>

<p>Also, Please double-check the paths before executing the commands.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/caffeinedev/Prabhat/Workspace/test_opencv/opencv-4.5.0/build/lib/python3/cv2.cpython-38-darwin.so
</code></pre></div></div>

<p>Open up another terminal and go to your python environment site-packages directory. 
In my case it’s</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/homebrew/Caskroom/miniforge/base/envs/testcv/lib/python3.8/site-packages

</code></pre></div></div>

<p>And execute the sym-link</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s /Users/caffeinedev/Prabhat/Workspace/test_opencv/opencv-4.5.0/build/lib/python3/cv2.cpython-38-darwin.so
</code></pre></div></div>

<p><img src="https://miro.medium.com/max/700/1*aMaG42tkpAiEQ1KTpWS8_A.png" alt="" /></p>

<p>This I ran on my second terminal.</p>

<p>And that’s it. Now we are good to go.</p>

<p>Open a separate terminal if you want and activate your virtual environment</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda activate testcv
</code></pre></div></div>
<p>And just run the below</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3
</code></pre></div></div>
<p>And</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cv2
cv2.__version__
</code></pre></div></div>

<p><img src="https://miro.medium.com/max/700/1*m-6LenCf8cwKBHyQm0gU-A.png" alt="" /></p>

<h2 id="step6-test-opencv-by-running-a-program">Step6: Test OpenCV by running a program</h2>

<p>Create a new file named main.py and paste the code below. Put a dummy photo for test purposes in the third line.
 The code just converts the image to a black-white image.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import cv2
image = cv2.imread('grogu.jpeg')
gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
cv2.imshow('Original image',image)
cv2.imshow('Gray image', gray)
cv2.waitKey(0)
cv2.destroyAllWindows()

</code></pre></div></div>

<p>And run python3 main.py. Here’s the output</p>

<p><img src="https://miro.medium.com/max/700/1*TNiqztLHSSofkScKHTjFkw.png" alt="" /></p>

<h4 id="additional-step">Additional Step</h4>

<p>If you want to uninstall OpenCV, you can go inside the build folder and run</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo make uninstall
</code></pre></div></div>
<p><img src="https://miro.medium.com/max/700/1*xH8rWQEkKNgIzvbJtqzLZQ.png" alt="" /></p>

<p>It will remove OpenCV 4.5.0 from your system. Also, you can delete your conda environment.</p>

<p>First, deactivate if it’s activated</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda deactivate
conda remove --name testcv --all
</code></pre></div></div>

<p>It will remove completely.</p>

<h4 id="conclusion">Conclusion</h4>

<p>We were able to build and install OpenCV 4.5.0 successfully in our M1 Mac and we are able to run some code also.</p>

<p>If you have any questions, recommendations, or critiques, I can be reached via <a href="https://twitter.com/thecaffeinedev">Twitter</a> or via my <a href="iprabhatdev@gmail.com">mail</a>. Feel free to reach out to me.</p>

<p>Thanks</p>

<h3 id="references">References:</h3>

<ul>
  <li>https://sayak.dev/install-opencv-m1/</li>
  <li>https://caffeinedev.medium.com/setting-up-tensorflow-on-m1-mac-36fe017ce284</li>
  <li>https://moeenv.blog/?p=209&amp;lang=en</li>
  <li>https://github.com/apple/tensorflow_macos/</li>
</ul>
:ET